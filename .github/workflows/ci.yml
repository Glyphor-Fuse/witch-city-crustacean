name: ci

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Concurrency policy:
# - PR checks should NOT be auto-cancelled, or required checks can stay "stuck" as cancelled.
# - Push runs (e.g. main) can still auto-cancel older in-progress runs.
concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name != 'pull_request' }}

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    # Skip CI for template bootstrap commits (first commit when repo is cloned from template)
    if: ${{ !contains(github.event.head_commit.message, '[initial-seed]') && !contains(github.event.head_commit.message, '[skip ci]') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  copilot-review:
    # Request Copilot code review on PRs (skip template commits)
    if: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.title, '[initial-seed]') }}
    runs-on: ubuntu-latest
    steps:
      - name: Request Copilot Review
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            let requested = false;
            try {
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number: prNumber,
                reviewers: ['Copilot']
              });
              requested = true;
              console.log('Copilot review requested via reviewer=Copilot');
            } catch (e) {
              console.log('Could not request reviewer "Copilot":', e.message);
            }

            if (!requested) {
              try {
                await github.rest.pulls.requestReviewers({
                  owner,
                  repo,
                  pull_number: prNumber,
                  reviewers: ['copilot-pull-request-reviewer[bot]']
                });
                requested = true;
                console.log('Copilot review requested via reviewer=copilot-pull-request-reviewer[bot]');
              } catch (e) {
                console.log('Could not request reviewer "copilot-pull-request-reviewer[bot]":', e.message);
              }
            }

            const pr = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
            const requestedReviewers = (pr.data.requested_reviewers || []).map(r => r.login);
            const copilotRequested = requestedReviewers.some((login) => /copilot/i.test(login));

            if (!requested || !copilotRequested) {
              core.setFailed(
                `Copilot review could not be requested. Requested reviewers: ${requestedReviewers.join(', ') || 'none'}. ` +
                `Enable Copilot code review for this repo/org and ensure Copilot reviewer is available.`
              );
            }

  copilot-review-gate:
    # Hard gate: ensure Copilot actually submits a review before auto-merge.
    needs: [build, copilot-review]
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Copilot review submission
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
            const deadline = Date.now() + 10 * 60 * 1000;

            let found = null;
            while (Date.now() < deadline) {
              const reviews = await github.rest.pulls.listReviews({
                owner,
                repo,
                pull_number: prNumber,
                per_page: 100,
              });

              found = (reviews.data || []).find((r) => {
                const login = r?.user?.login || '';
                const state = (r?.state || '').toUpperCase();
                return /copilot/i.test(login) && state !== '' && state !== 'PENDING';
              });

              if (found) break;
              await sleep(20_000);
            }

            if (!found) {
              core.setFailed(
                'Copilot did not submit a review within 10 minutes. ' +
                'PR is blocked to avoid merging without Copilot feedback.'
              );
            } else {
              core.info(`Copilot review detected: ${found.user.login} (${found.state})`);
            }

  auto-merge:
    # Auto-merge PRs created by Glyphor AI after CI passes
    needs: [build, copilot-review-gate]
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const headRef = context.payload.pull_request.head.ref;
            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

            const repoInfo = await github.rest.repos.get({ owner, repo });
            const allowedMethods = [];
            if (repoInfo.data.allow_merge_commit) allowedMethods.push('merge');
            if (repoInfo.data.allow_squash_merge) allowedMethods.push('squash');
            if (repoInfo.data.allow_rebase_merge) allowedMethods.push('rebase');

            if (allowedMethods.length === 0) {
              throw new Error('No merge methods enabled on repository settings');
            }

            console.log(`Allowed merge methods: ${allowedMethods.join(', ')}`);

            let merged = false;
            let lastError = '';

            // Retry for a few minutes so external required checks (e.g. Vercel) can finish.
            for (let attempt = 1; attempt <= 15 && !merged; attempt++) {
              const pr = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber,
              });

              if (pr.data.merged || pr.data.state === 'closed') {
                console.log(`PR #${prNumber} already merged/closed`);
                merged = true;
                break;
              }

              for (const method of allowedMethods) {
                try {
                  await github.rest.pulls.merge({
                    owner,
                    repo,
                    pull_number: prNumber,
                    merge_method: method,
                  });
                  console.log(`PR #${prNumber} merged using ${method} (attempt ${attempt})`);
                  merged = true;
                  break;
                } catch (err) {
                  const msg = err?.message || String(err);
                  lastError = `[${method}] ${msg}`;
                  console.log(`Attempt ${attempt} merge via ${method} failed: ${msg}`);
                }
              }

              if (!merged && attempt < 15) {
                await sleep(20_000);
              }
            }

            if (!merged) {
              throw new Error(`Auto-merge failed after retries: ${lastError || 'unknown error'}`);
            }

            // Delete branch after successful merge (non-fatal if it fails)
            try {
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: `heads/${headRef}`,
              });
              console.log(`Branch ${headRef} deleted`);
            } catch (delErr) {
              console.log('Branch deletion failed (non-fatal):', delErr.message);
            }

  retag-copilot-on-build-failure:
    # If CI build fails on a PR, re-request Copilot and tag @copilot with context.
    needs: [build]
    if: ${{ always() && github.event_name == 'pull_request' && needs.build.result == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: Re-request Copilot and post failure context
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const headSha = context.payload.pull_request.head.sha;

            // Try to request Copilot reviewer again (best effort).
            try {
              await github.rest.pulls.requestReviewers({
                owner,
                repo,
                pull_number: prNumber,
                reviewers: ['copilot-pull-request-reviewer[bot]']
              });
              core.info('Re-requested Copilot reviewer');
            } catch (e) {
              core.info(`Could not re-request Copilot reviewer: ${e.message}`);
            }

            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
            const body = `@copilot CI build failed on this PR. Please retry your review with focus on the failing checks and propose concrete fixes.
            
            - Failed workflow run: ${runUrl}
            - Commit: \`${headSha}\`
            - Triggered by: \`retag-copilot-on-build-failure\``;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body
            });
            core.info('Posted @copilot retag comment');
